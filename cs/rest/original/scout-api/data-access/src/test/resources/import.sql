DROP TABLE activity_derived
IF EXISTS;

-- Changes to this view should be mirrored in api\...\import.sql and scout-api\api\...\migrations.xml
CREATE VIEW activity_derived AS
  SELECT
    A.ID                            ACTIVITY_ID,
    SUM(CAST(AUR.FAVOURITE AS INT)) FAVOURITES_COUNT,
    SUM(AUR.RATING)                 RATINGS_SUM,
    COUNT(AUR.RATING)               RATINGS_COUNT,
    AVG(AUR.RATING)                 RATINGS_AVG
  FROM ACTIVITY A LEFT JOIN ACTIVITY_RATING AUR ON A.ID = AUR.ACTIVITY_ID
  GROUP BY A.ID;

DROP TABLE tag_derived
IF EXISTS;

-- Changes to this view should be mirrored in api\...\import.sql and scout-api\api\...\migrations.xml
CREATE VIEW tag_derived AS
  SELECT
    T.ID                              TAG_ID,
    COUNT(APT.ACTIVITY_PROPERTIES_ID) ACTIVITIES_COUNT
  FROM TAG T LEFT JOIN ACTIVITY_PROPERTIES_TAG APT ON T.ID = APT.TAG_ID
    INNER JOIN ACTIVITY_PROPERTIES AP ON (APT.ACTIVITY_PROPERTIES_ID = AP.ID AND AP.PUBLISHING_ACTIVITY_ID IS NOT NULL)
  GROUP BY T.ID;

INSERT INTO USERS (ID, NAME, AUTHORIZATION_LEVEL) VALUES (1, 'Alice', 0);
INSERT INTO USER_IDENTITY (ID, USER_ID, TYPE, VALUE) VALUES (1, 1, 'API', 'alice-key');

INSERT INTO USERS (ID, NAME, AUTHORIZATION_LEVEL) VALUES (2, 'Carol', 0);
INSERT INTO USER_IDENTITY (ID, USER_ID, TYPE, VALUE) VALUES (2, 2, 'API', 'carol-key-1');
INSERT INTO USER_IDENTITY (ID, USER_ID, TYPE, VALUE) VALUES (3, 2, 'API', 'carol-key-2');

INSERT INTO USERS (ID, NAME, AUTHORIZATION_LEVEL) VALUES (3, 'Emily', 0);
INSERT INTO USER_IDENTITY (ID, USER_ID, TYPE, VALUE) VALUES (4, 3, 'API', 'emily-key');

INSERT INTO MEDIA_FILE (ID, NAME, MIME_TYPE, URI) VALUES (1, 'Albatros', 'image/jpeg', 'http://example.com/images/albatros.jpg');
INSERT INTO MEDIA_FILE (ID, NAME, MIME_TYPE, URI) VALUES (2, 'Bear', 'image/png', 'file:/photos/bear.png');
INSERT INTO MEDIA_FILE (ID, NAME, MIME_TYPE, URI) VALUES (3, 'Cat Poster', 'application/pdf', 'file:/attachments/cat-poster.pdf');
INSERT INTO MEDIA_FILE (ID, NAME, MIME_TYPE, URI) VALUES (4, 'Elephant', null, 'file:/attachments/elephant-facts.pdf');
INSERT INTO MEDIA_FILE_KEYWORDS (MEDIA_FILE_ID, KEYWORD) VALUES (4, 'elephant');
INSERT INTO MEDIA_FILE_KEYWORDS (MEDIA_FILE_ID, KEYWORD) VALUES (4, 'trunk');
INSERT INTO MEDIA_FILE_KEYWORDS (MEDIA_FILE_ID, KEYWORD) VALUES (4, 'dumbo');

INSERT INTO TAG (ID, GRP, NAME, MEDIA_FILE_ID) VALUES (1, 'grp', 'Fun', 3);
INSERT INTO TAG (ID, GRP, NAME, MEDIA_FILE_ID) VALUES (2, 'grp', 'Adventure', NULL);
INSERT INTO TAG (ID, GRP, NAME, MEDIA_FILE_ID) VALUES (3, 'grp', 'Relaxing', NULL);
INSERT INTO TAG (ID, GRP, NAME, MEDIA_FILE_ID) VALUES (4, 'location', 'Outdoors', NULL);
INSERT INTO TAG (ID, GRP, NAME, MEDIA_FILE_ID) VALUES (5, 'location', 'Indoors', NULL);
INSERT INTO TAG (ID, GRP, NAME, MEDIA_FILE_ID) VALUES (6, 'grp', 'Indoors', NULL);

INSERT INTO ACTIVITY (ID) VALUES (1);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (1, 1, null, 'Activity 1.1', TIMESTAMP '2015-01-01 00:00:01', TIMESTAMP '2015-01-01 00:00:02', TIMESTAMP '2015-01-01 00:00:03', 'DESCRIPTION_MATERIAL', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 10, 15, 1, 5, 10, 30, 0);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (2, 1, null,'Activity 1.2', TIMESTAMP '2015-01-01 00:00:04', TIMESTAMP '2015-01-01 00:00:05', TIMESTAMP '2015-01-01 00:00:06', 'DESCRIPTION_MATERIAL', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 10, 15, 1, 5, 10, 30, 0);
-- This tag assignment should not be counted by Tag.getActivityCount() since the PUBLISHING_ACTIVITY_ID is null.
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (2, 1);
-- This tag assignment should not be counted by Tag.getActivityCount() since the PUBLISHING_ACTIVITY_ID is null.
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (2, 5);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (3, 1, 1, 'Activity 1.3', TIMESTAMP '2015-01-01 00:00:07', TIMESTAMP '2015-01-01 00:00:08', TIMESTAMP '2015-01-01 00:00:09', 'DESCRIPTION_MATERIAL', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 10, 15, 1, 5, 10, 30, 0);
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (3, 1);
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (3, 2);

INSERT INTO ACTIVITY (ID) VALUES (2);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (4, 2, 2, 'Activity 2.0', TIMESTAMP '2015-01-01 00:00:07', TIMESTAMP '2015-01-01 00:00:08', TIMESTAMP '2015-01-01 00:00:09', 'DESCRIPTION_MATERIAL', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 10, 15, 1, 5, 10, 30, 0);
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (4, 2);
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (4, 3);

INSERT INTO ACTIVITY (ID) VALUES (3);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (5, 3, 3, 'Tag', TIMESTAMP '2015-01-01 00:00:07', TIMESTAMP '2015-01-01 00:00:08', TIMESTAMP '2015-01-01 00:00:09', 'DESCRIPTION_MATERIAL', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 0, 10, 1, 5, 10, 30, 1);
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (5, 3);
INSERT INTO ACTIVITY_PROPERTIES_TAG (ACTIVITY_PROPERTIES_ID, TAG_ID) VALUES (5, 4);
-- Associate media file 4 with an activity so that testDeleteMediaFileWhichIsUsed verifies that cascading deletes work as expected.
INSERT INTO ACTIVITY_PROPERTIES_MEDIA_FILE (ACTIVITY_PROPERTIES_ID, MEDIA_FILE_ID, FEATURED) VALUES (5, 4, TRUE);

INSERT INTO ACTIVITY (ID) VALUES (4);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (6, 4, 4, 'Cowboys and Indians', TIMESTAMP '2015-01-01 00:00:07', TIMESTAMP '2015-01-01 00:00:08', TIMESTAMP '2015-01-01 00:00:09', 'This is not a variant of tag, but it is about running around and catching people.', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 5, 15, 1, 5, 10, 30, 1);

INSERT INTO ACTIVITY (ID) VALUES (5);
INSERT INTO ACTIVITY_PROPERTIES (ID, ACTIVITY_ID, PUBLISHING_ACTIVITY_ID, NAME, DATE_CREATED, DATE_UPDATED, DATE_PUBLISHED, DESCRIPTION_MATERIAL, DESCRIPTION_INTRODUCTION, DESCRIPTION_PREPARE, DESCRIPTION_MAIN, DESCRIPTION_SAFETY, DESCRIPTION_NOTES, AGE_MIN, AGE_MAX, PARTICIPANTS_MIN, PARTICIPANTS_MAX, TIME_MIN, TIME_MAX, FEATURED) VALUES (7, 5, 5, 'Tag with a twist', TIMESTAMP '2015-01-01 00:00:07', TIMESTAMP '2015-01-01 00:00:08', TIMESTAMP '2015-01-01 00:00:09', 'DESCRIPTION_MATERIAL', 'DESCRIPTION_INTRODUCTION', 'DESCRIPTION_PREPARE', 'DESCRIPTION_MAIN', 'DESCRIPTION_SAFETY', 'DESCRIPTION_NOTES', 15, 99, 1, 5, 10, 30, 1);